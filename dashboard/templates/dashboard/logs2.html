{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Logs{% endblock %}

{% block subheader %}
    {% with active_tab='logs' %}
        {% include 'dashboard/partials/sub_header.html' %}
    {% endwith %}
{% endblock %}

{% block content %}
<div class="logs-page-container">
    <div class="logs-main-content">
        <div class="logs-content-header">
            <div class="controls-bar logs-controls-row">
                <div class="logs-controls-group">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search logs..." id="globalSearch" />
                    </div>
                    <div class="log-summary">
                        Total: <span id="total-logs">{{ total_logs_count|default:"0" }}</span> Logs 
                        {% if total_logs_count|default:0 > 1000 %}(Log Throttling may be ON){% endif %}
                    </div>
                    <div class="date-range-display">
                        {% if time_range %}
                            {{ time_range|title }}
                        {% else %}
                            Last Hour
                        {% endif %}
                    </div>
                    <div class="action-buttons">
                        <button class="icon-text-button" onclick="refreshLogs()"><i class="fas fa-sync-alt"></i></button>
                        <button class="icon-text-button" onclick="toggleFilters()"><i class="fas fa-filter"></i></button>
                        <button class="icon-text-button"><i class="fas fa-download"></i> Export</button>
                    </div>
                </div>
            </div>
        </div>
                <style>
                .status-label {
                    padding: 0.2em 0.6em;
                    border-radius: 0.25em;
                    font-weight: bold;
                    font-size: 0.85em;
                    text-transform: capitalize;
                }
                .status-deny {
                    background-color: #dc3545; /* Red */
                    color: white;
                }
                .status-accept {
                    background-color: #28a745; /* Green */
                    color: white;
                }
                .status-other {
                    background-color: #ffc107; /* Yellow */
                    color: black;
                }

                .source-badge {
                    padding: 0.2em 0.6em;
                    border-radius: 0.25em;
                    font-weight: bold;
                    font-size: 0.8em;
                    text-transform: capitalize;
                }
                .source-fortigate_traffic {
                    background-color: #17a2b8; /* Info blue */
                    color: white;
                }
                .source-pa_traffic {
                    background-color: #fd7e14; /* Orange */
                    color: white;
                }
                .source-threat_logs {
                    background-color: #dc3545; /* Red */
                    color: white;
                }
                .source-unknown {
                    background-color: #6c757d; /* Secondary gray */
                    color: white;
                }

                .logs-controls-row {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 1.5rem;
                    flex-wrap: wrap;
                }
                .logs-controls-group {
                    display: flex;
                    align-items: center;
                    gap: 1.2rem;
                    flex-wrap: wrap;
                }
                .logs-controls-filter {
                    min-width: 260px;
                    display: flex;
                    justify-content: flex-end;
                }
                @media (max-width: 900px) {
                    .logs-controls-row {
                        flex-direction: column;
                        align-items: stretch;
                        gap: 0.8rem;
                    }
                    .logs-controls-group {
                        flex-direction: column;
                        align-items: stretch;
                        gap: 0.7rem;
                    }
                    .logs-controls-filter {
                        justify-content: flex-start;
                    }
                }

                /* Professional Filter Sidebar Styles */
                .logs-page-container {
                    display: flex;
                    gap: 20px;
                    max-width: 100%;
                    overflow: visible;
                    width: 100%;
                }

                .logs-main-content {
                    flex: 1;
                    min-width: 0;
                    width: calc(100% - 300px);
                    overflow-x: auto;
                }

                .logs-filter-sidebar {
                    width: 280px;
                    min-width: 280px;
                    background: #fff;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    border: 1px solid #e1e5e9;
                    height: fit-content;
                    max-height: calc(100vh - 200px);
                    overflow-y: auto;
                    position: sticky;
                    top: 20px;
                    transition: all 0.3s ease;
                    flex-shrink: 0;
                    display: block;
                    visibility: visible;
                }

                .logs-filter-sidebar.hidden {
                    display: none;
                }

                .logs-main-content.sidebar-hidden {
                    width: 100%;
                }

                .logs-table-container {
                    width: 100%;
                    overflow-x: auto;
                }

                .filter-sidebar-header {
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                    padding: 12px 16px;
                    border-bottom: 1px solid #dee2e6;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-radius: 8px 8px 0 0;
                }

                .filter-sidebar-header h3 {
                    margin: 0;
                    font-size: 14px;
                    font-weight: 600;
                    color: #495057;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }

                .filter-sidebar-header h3 i {
                    color: #667eea;
                    font-size: 12px;
                }

                .clear-all-filters {
                    background: none;
                    border: 1px solid #dc3545;
                    color: #dc3545;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 10px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }

                .clear-all-filters:hover {
                    background: #dc3545;
                    color: white;
                }

                .filter-sections {
                    padding: 0;
                    max-height: calc(100vh - 340px);
                    overflow-y: auto;
                }

                .filter-section {
                    border-bottom: 1px solid #f1f3f4;
                }

                .filter-section:last-child {
                    border-bottom: none;
                }

                .filter-section-header {
                    padding: 10px 16px;
                    background: #fafbfc;
                    border-bottom: 1px solid #e9ecef;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 12px;
                    font-weight: 600;
                    color: #495057;
                    cursor: pointer;
                    transition: background-color 0.2s ease;
                }

                .filter-section-header:hover {
                    background: #f1f3f4;
                }

                .filter-section-header i {
                    color: #667eea;
                    font-size: 11px;
                    width: 12px;
                }

                .filter-section-content {
                    padding: 12px 16px;
                }

                .filter-group {
                    margin-bottom: 12px;
                }

                .filter-group:last-child {
                    margin-bottom: 0;
                }

                .filter-group label {
                    display: block;
                    font-size: 11px;
                    font-weight: 500;
                    color: #6c757d;
                    margin-bottom: 4px;
                    text-transform: uppercase;
                    letter-spacing: 0.3px;
                }

                .filter-input {
                    width: 100%;
                    padding: 6px 8px;
                    font-size: 11px;
                    border: 1px solid #ced4da;
                    border-radius: 4px;
                    background: #fff;
                    color: #495057;
                    transition: all 0.2s ease;
                    box-sizing: border-box;
                }

                .filter-input:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
                }

                .filter-input::placeholder {
                    color: #adb5bd;
                    font-size: 10px;
                }

                .filter-input[type="number"] {
                    -moz-appearance: textfield;
                }

                .filter-input[type="number"]::-webkit-outer-spin-button,
                .filter-input[type="number"]::-webkit-inner-spin-button {
                    -webkit-appearance: none;
                    margin: 0;
                }

                .filter-actions {
                    padding: 12px 16px;
                    border-top: 1px solid #dee2e6;
                    background: #fafbfc;
                    display: flex;
                    gap: 8px;
                    border-radius: 0 0 8px 8px;
                }

                .apply-filters-btn, .reset-filters-btn {
                    flex: 1;
                    padding: 8px 12px;
                    border: none;
                    border-radius: 4px;
                    font-size: 11px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                }

                .apply-filters-btn {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }

                .apply-filters-btn:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                }

                .reset-filters-btn {
                    background: #fff;
                    color: #6c757d;
                    border: 1px solid #ced4da;
                }

                .reset-filters-btn:hover {
                    background: #f8f9fa;
                    color: #495057;
                }

                /* Responsive Design */
                @media (max-width: 768px) {
                    .logs-page-container {
                        flex-direction: column;
                    }

                    .logs-main-content {
                        width: 100% !important;
                    }

                    .logs-filter-sidebar {
                        width: 100%;
                        min-width: 100%;
                        position: relative;
                        top: 0;
                        max-height: 400px;
                        order: -1;
                        margin-bottom: 20px;
                    }

                    .logs-filter-sidebar.hidden {
                        display: none;
                    }
                }


                /* Scrollbar Styling */
                .filter-sections::-webkit-scrollbar,
                .logs-filter-sidebar::-webkit-scrollbar {
                    width: 4px;
                }

                .filter-sections::-webkit-scrollbar-track,
                .logs-filter-sidebar::-webkit-scrollbar-track {
                    background: #f1f1f1;
                    border-radius: 2px;
                }

                .filter-sections::-webkit-scrollbar-thumb,
                .logs-filter-sidebar::-webkit-scrollbar-thumb {
                    background: #c1c1c1;
                    border-radius: 2px;
                }

                .filter-sections::-webkit-scrollbar-thumb:hover,
                .logs-filter-sidebar::-webkit-scrollbar-thumb:hover {
                    background: #a8a8a8;
                }

                /* Enhanced Filter Styles */
                .time-range-tabs {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 6px;
                    margin-bottom: 8px;
                }

                .time-tab {
                    padding: 6px 10px;
                    border: 1px solid #dee2e6;
                    background: #fff;
                    border-radius: 6px;
                    font-size: 11px;
                    font-weight: 600;
                    color: #6c757d;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-align: center;
                }

                .time-tab:hover {
                    background: #f8f9fa;
                    border-color: #667eea;
                    color: #667eea;
                }

                .time-tab.active {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-color: #667eea;
                    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
                }

                .custom-time-range {
                    margin-top: 8px;
                    padding-top: 8px;
                    border-top: 1px solid #e9ecef;
                }

                .hidden {
                    display: none !important;
                }

                /* Quick Filters */
                .quick-filter-buttons {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 6px;
                }

                .quick-filter-btn {
                    padding: 8px 10px;
                    border: 1px solid #dee2e6;
                    background: #fff;
                    border-radius: 6px;
                    font-size: 10px;
                    font-weight: 500;
                    color: #495057;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                    white-space: nowrap;
                }

                .quick-filter-btn:hover {
                    background: #f8f9fa;
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
                }

                .quick-filter-btn.active {
                    background: #667eea;
                    color: white;
                    border-color: #667eea;
                }

                .quick-filter-btn i {
                    font-size: 11px;
                }

                /* Filter Counter Badge */
                .filter-count-badge {
                    background: #dc3545;
                    color: white;
                    font-size: 9px;
                    padding: 2px 6px;
                    border-radius: 10px;
                    margin-left: 4px;
                    font-weight: 600;
                }

                /* Real-time filter indicator */
                .filter-input.filtering {
                    border-color: #667eea;
                    background: #f0f4ff;
                }

                /* Animated filter transitions */
                .filter-section {
                    transition: all 0.3s ease;
                }

                .filter-section:hover {
                    background: rgba(102, 126, 234, 0.02);
                }

                /* Enhanced IP input with validation */
                .filter-input.invalid {
                    border-color: #dc3545;
                    background: #fff5f5;
                }

                .filter-input.valid {
                    border-color: #28a745;
                    background: #f5fff5;
                }

                /* Filter search box */
                .filter-search-box {
                    margin-bottom: 12px;
                    position: relative;
                }

                .filter-search-box input {
                    width: 100%;
                    padding: 8px 12px 8px 32px;
                    font-size: 11px;
                    border: 1px solid #dee2e6;
                    border-radius: 6px;
                    background: #f8f9fa;
                }

                .filter-search-box i {
                    position: absolute;
                    left: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: #6c757d;
                    font-size: 11px;
                }

                /* Loading indicator */
                .filter-loading {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    display: none;
                }

                .filter-loading.active {
                    display: block;
                }

                /* Enhanced mobile responsiveness */
                @media (max-width: 480px) {
                    .quick-filter-buttons {
                        grid-template-columns: 1fr;
                    }
                    
                    .time-range-tabs {
                        grid-template-columns: repeat(2, 1fr);
                    }
                }

                /* Filter tooltips */
                .filter-tooltip {
                    position: relative;
                    display: inline-block;
                }

                .filter-tooltip .tooltip-text {
                    visibility: hidden;
                    width: 120px;
                    background-color: #333;
                    color: #fff;
                    text-align: center;
                    border-radius: 4px;
                    padding: 4px 8px;
                    position: absolute;
                    z-index: 1;
                    bottom: 125%;
                    left: 50%;
                    margin-left: -60px;
                    opacity: 0;
                    transition: opacity 0.3s;
                    font-size: 10px;
                }

                .filter-tooltip:hover .tooltip-text {
                    visibility: visible;
                    opacity: 1;
                }
                </style>

            <!-- If you want a chart, add a canvas element here, e.g.: -->
            <!-- <canvas id="logsChart" style="width:100%;max-width:700px;height:200px;margin-bottom:20px;"></canvas> -->

            <div class="logs-table-container">
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Source IP</th>
                            <th>Destination IP</th>
                            <th>Destination Port</th>
                            <th>Protocol</th>
                            <th>Source</th>
                            <th>Received Bytes</th>
                            <th>Transmitted Bytes</th>
                            <th>Duration</th>
                            <th></th> <!-- For the expand button -->
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        {% for log_item in logs_for_display %}
                        <tr>
                            <td>{{ log_item.ts_display }}</td>
                            <td>
                                <span class="status-label 
                                    {% if log_item.action|default:""|lower == 'deny' %}status-deny
                                    {% elif log_item.action|default:""|lower == 'accept' or log_item.action|default:""|lower == 'allow' %}status-accept
                                    {% else %}status-other{% endif %}">
                                    {{ log_item.action|default:"N/A" }}
                                </span>
                            </td>
                            <td>{{ log_item.srcip }}</td>
                            <td>{{ log_item.dstip }}</td>
                            <td>{{ log_item.dstport_val }}</td>
                            <td>{{ log_item.proto_str }}</td>
                            <td>
                                <span class="source-badge source-{{ log_item.log_source|default:'unknown' }}">
                                    {% if log_item.log_source == 'fortigate_traffic' %}FortiGate
                                    {% elif log_item.log_source == 'pa_traffic' %}PaloAlto
                                    {% elif log_item.log_source == 'threat_logs' %}Threat
                                    {% else %}{{ log_item.log_source|default:'Unknown' }}{% endif %}
                                </span>
                            </td>
                            <td>{{ log_item.rcvdbyte_display }}</td>
                            <td>{{ log_item.sentbyte_display }}</td>
                            <td>{{ log_item.duration_display }}</td>
                            <td><button class="expand-log-button" data-log-index="{{ forloop.counter0 }}"><i class="fas fa-plus"></i></button></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 20px;">No logs found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!-- Pagination Bar -->
                {% if total_pages > 1 %}
                <div class="pagination-bar" style="display: flex; justify-content: center; align-items: center; margin: 24px 0;">
                    <nav aria-label="Logs pagination">
                        <ul class="pagination" style="display: flex; gap: 4px; list-style: none; padding: 0;">
                            {% if current_page > 1 %}
                            <li><a class="pagination-link" href="?page={{ current_page|add:'-1' }}" style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; color: #333;">« Previous</a></li>
                            {% else %}
                            <li><span class="pagination-link disabled" style="padding: 6px 12px; border: 1px solid #eee; border-radius: 4px; color: #bbb;">« Previous</span></li>
                            {% endif %}
                            
                            {% for page_num in page_range %}
                                {% if page_num == current_page %}
                                    <li><span class="pagination-link active" style="padding: 6px 12px; border: 1px solid #007bff; background: #007bff; color: #fff; border-radius: 4px;">{{ page_num }}</span></li>
                                {% else %}
                                    <li><a class="pagination-link" href="?page={{ page_num }}" style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; color: #333;">{{ page_num }}</a></li>
                                {% endif %}
                            {% endfor %}
                             {% if total_pages > 5 and current_page < total_pages|add:"-2" %} {# Ellipsis if many pages #}
                                <li><span style="padding: 6px 12px;">...</span></li>
                                <li><a class="pagination-link" href="?page={{ total_pages }}" style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; color: #333;">{{ total_pages }}</a></li>
                            {% elif total_pages > 5 and current_page >= total_pages|add:"-2" and current_page != total_pages %}
                                <!-- Show last few pages if close to end -->
                                {% for _ in "123" %} 
                                    {% with page_num=forloop.counter0|add:total_pages|add:"-2" %}
                                        {% if page_num > 5 and page_num != current_page and page_num <= total_pages %}
                                        <li><a class="pagination-link" href="?page={{ page_num }}" style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; color: #333;">{{ page_num }}</a></li>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            {% endif %}


                            {% if current_page < total_pages %}
                            <li><a class="pagination-link" href="?page={{ current_page|add:'1' }}" style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; color: #333;">Next »</a></li>
                            {% else %}
                            <li><span class="pagination-link disabled" style="padding: 6px 12px; border: 1px solid #eee; border-radius: 4px; color: #bbb;">Next »</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Professional Filter Sidebar -->
        <div class="logs-filter-sidebar" id="filterSidebar">
            <div class="filter-sidebar-header">
                <h3><i class="fas fa-filter"></i> Filters</h3>
                <button class="clear-all-filters" onclick="clearAllFilters()">
                    <i class="fas fa-times"></i> Clear All
                </button>
            </div>
            
            <div class="filter-sections">
                <!-- Quick Filters -->
                <div class="filter-section quick-filters-section">
                    <div class="filter-section-header">
                        <i class="fas fa-bolt"></i>
                        <span>Quick Filters</span>
                    </div>
                    <div class="filter-section-content">
                        <div class="quick-filter-buttons">
                            <button type="button" class="quick-filter-btn" data-filter="denied">
                                <i class="fas fa-ban"></i> Denied Traffic
                            </button>
                            <button type="button" class="quick-filter-btn" data-filter="high-traffic">
                                <i class="fas fa-chart-line"></i> High Traffic
                            </button>
                            <button type="button" class="quick-filter-btn" data-filter="suspicious">
                                <i class="fas fa-exclamation-triangle"></i> Suspicious
                            </button>
                            <button type="button" class="quick-filter-btn" data-filter="external">
                                <i class="fas fa-globe-americas"></i> External Only
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Time Range Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-clock"></i>
                        <span>Time Range</span>
                    </div>
                    <div class="filter-section-content">
                        <div class="time-range-tabs">
                            <button type="button" class="time-tab active" data-range="last_hour">1H</button>
                            <button type="button" class="time-tab" data-range="last_6_hours">6H</button>
                            <button type="button" class="time-tab" data-range="last_24_hours">24H</button>
                            <button type="button" class="time-tab" data-range="last_7_days">7D</button>
                            <button type="button" class="time-tab" data-range="last_30_days">30D</button>
                            <button type="button" class="time-tab" data-range="custom">Custom</button>
                        </div>
                        <select class="filter-input hidden" name="time_range" id="timeRangeFilter">
                            <option value="last_hour" {% if time_range == 'last_hour' %}selected{% endif %}>Last Hour</option>
                            <option value="last_6_hours" {% if time_range == 'last_6_hours' %}selected{% endif %}>Last 6 Hours</option>
                            <option value="last_24_hours" {% if time_range == 'last_24_hours' %}selected{% endif %}>Last 24 Hours</option>
                            <option value="last_7_days" {% if time_range == 'last_7_days' %}selected{% endif %}>Last 7 Days</option>
                            <option value="last_30_days" {% if time_range == 'last_30_days' %}selected{% endif %}>Last 30 Days</option>
                            <option value="custom" {% if time_range == 'custom' %}selected{% endif %}>Custom Range</option>
                        </select>
                        <div class="custom-time-range" id="customTimeRange" style="display: none;">
                            <div class="filter-group">
                                <label>From</label>
                                <input type="datetime-local" class="filter-input" name="time_from" id="timeFrom" value="{{ time_from|default:'' }}">
                            </div>
                            <div class="filter-group">
                                <label>To</label>
                                <input type="datetime-local" class="filter-input" name="time_to" id="timeTo" value="{{ time_to|default:'' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IP Address Filters -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-network-wired"></i>
                        <span>IP Addresses</span>
                    </div>
                    <div class="filter-section-content">
                        <div class="filter-group">
                            <label>Source IP</label>
                            <input type="text" class="filter-input" name="srcip" 
                                   placeholder="e.g., 192.168.1.1" 
                                   value="{{ srcip_filter|default:'' }}">
                        </div>
                        <div class="filter-group">
                            <label>Destination IP</label>
                            <input type="text" class="filter-input" name="dstip" 
                                   placeholder="e.g., 10.0.0.1" 
                                   value="{{ dstip_filter|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Port Filters -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-plug"></i>
                        <span>Ports</span>
                    </div>
                    <div class="filter-section-content">
                        <div class="filter-group">
                            <label>Source Port</label>
                            <input type="number" class="filter-input" name="srcport" 
                                   placeholder="1-65535" min="1" max="65535"
                                   value="{{ srcport_filter|default:'' }}">
                        </div>
                        <div class="filter-group">
                            <label>Destination Port</label>
                            <input type="number" class="filter-input" name="dstport" 
                                   placeholder="1-65535" min="1" max="65535"
                                   value="{{ dstport_filter|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Action Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-shield-alt"></i>
                        <span>Action</span>
                    </div>
                    <div class="filter-section-content">
                        <select class="filter-input" name="action" id="actionFilter">
                            <option value="">All Actions</option>
                            <option value="accept" {% if action_filter == 'accept' %}selected{% endif %}>Accept</option>
                            <option value="allow" {% if action_filter == 'allow' %}selected{% endif %}>Allow</option>
                            <option value="deny" {% if action_filter == 'deny' %}selected{% endif %}>Deny</option>
                            <option value="block" {% if action_filter == 'block' %}selected{% endif %}>Block</option>
                            <option value="drop" {% if action_filter == 'drop' %}selected{% endif %}>Drop</option>
                        </select>
                    </div>
                </div>

                <!-- Log Source Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-database"></i>
                        <span>Log Source</span>
                    </div>
                    <div class="filter-section-content">
                        <select class="filter-input" name="log_source" id="logSourceFilter">
                            <option value="">All Sources</option>
                            <option value="fortigate_traffic" {% if log_source_filter == 'fortigate_traffic' %}selected{% endif %}>FortiGate Traffic</option>
                            <option value="pa_traffic" {% if log_source_filter == 'pa_traffic' %}selected{% endif %}>PaloAlto Traffic</option>
                            <option value="threat_logs" {% if log_source_filter == 'threat_logs' %}selected{% endif %}>Threat Logs</option>
                        </select>
                    </div>
                </div>

                <!-- Protocol Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-layer-group"></i>
                        <span>Protocol</span>
                    </div>
                    <div class="filter-section-content">
                        <select class="filter-input" name="protocol" id="protocolFilter">
                            <option value="">All Protocols</option>
                            <option value="TCP" {% if protocol_filter == 'TCP' %}selected{% endif %}>TCP</option>
                            <option value="UDP" {% if protocol_filter == 'UDP' %}selected{% endif %}>UDP</option>
                            <option value="ICMP" {% if protocol_filter == 'ICMP' %}selected{% endif %}>ICMP</option>
                            <option value="GRE" {% if protocol_filter == 'GRE' %}selected{% endif %}>GRE</option>
                        </select>
                    </div>
                </div>

                <!-- Device Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-server"></i>
                        <span>Device</span>
                    </div>
                    <div class="filter-section-content">
                        <select class="filter-input" name="devname" id="deviceFilter">
                            <option value="">All Devices</option>
                            {% for device in available_devices %}
                            <option value="{{ device }}" {% if devname_filter == device %}selected{% endif %}>{{ device }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Application Category Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-tags"></i>
                        <span>App Category</span>
                    </div>
                    <div class="filter-section-content">
                        <input type="text" class="filter-input" name="appcategory" 
                               placeholder="e.g., Web-browsing" 
                               value="{{ appcategory_filter|default:'' }}">
                    </div>
                </div>

                <!-- Hostname Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-globe"></i>
                        <span>Hostname</span>
                    </div>
                    <div class="filter-section-content">
                        <input type="text" class="filter-input" name="hostname" 
                               placeholder="e.g., google.com" 
                               value="{{ hostname_filter|default:'' }}">
                    </div>
                </div>

                <!-- Username Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-user"></i>
                        <span>Username</span>
                    </div>
                    <div class="filter-section-content">
                        <input type="text" class="filter-input" name="username" 
                               placeholder="Enter username" 
                               value="{{ username_filter|default:'' }}">
                    </div>
                </div>

                <!-- Country Filter -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>Destination Country</span>
                    </div>
                    <div class="filter-section-content">
                        <input type="text" class="filter-input" name="dstcountry" 
                               placeholder="e.g., US, CN, GB" 
                               value="{{ dstcountry_filter|default:'' }}">
                    </div>
                </div>

                <!-- Byte Range Filters -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-chart-bar"></i>
                        <span>Byte Range</span>
                    </div>
                    <div class="filter-section-content">
                        <div class="filter-group">
                            <label>Min Bytes</label>
                            <input type="number" class="filter-input" name="min_bytes" 
                                   placeholder="0" min="0" value="{{ min_bytes_filter|default:'' }}">
                        </div>
                        <div class="filter-group">
                            <label>Max Bytes</label>
                            <input type="number" class="filter-input" name="max_bytes" 
                                   placeholder="1000000" min="0" value="{{ max_bytes_filter|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Duration Range Filters -->
                <div class="filter-section">
                    <div class="filter-section-header">
                        <i class="fas fa-stopwatch"></i>
                        <span>Duration Range</span>
                    </div>
                    <div class="filter-section-content">
                        <div class="filter-group">
                            <label>Min Duration (ms)</label>
                            <input type="number" class="filter-input" name="min_duration" 
                                   placeholder="0" min="0" value="{{ min_duration_filter|default:'' }}">
                        </div>
                        <div class="filter-group">
                            <label>Max Duration (ms)</label>
                            <input type="number" class="filter-input" name="max_duration" 
                                   placeholder="10000" min="0" value="{{ max_duration_filter|default:'' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Actions -->
            <div class="filter-actions">
                <button class="apply-filters-btn" onclick="applyFilters()">
                    <i class="fas fa-search"></i> Apply Filters
                </button>
                <button class="reset-filters-btn" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
// Filter Sidebar Functionality
function toggleFilters() {
    const sidebar = document.getElementById('filterSidebar');
    const mainContent = document.querySelector('.logs-main-content');
    
    sidebar.classList.toggle('hidden');
    mainContent.classList.toggle('sidebar-hidden');
}

function applyFilters() {
    const form = document.createElement('form');
    form.method = 'GET';
    form.action = window.location.pathname;

    // Collect all filter values
    const filterInputs = document.querySelectorAll('.filter-input:not(.hidden)');
    filterInputs.forEach(input => {
        if (input.value.trim()) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = input.name;
            hiddenInput.value = input.value.trim();
            form.appendChild(hiddenInput);
        }
    });

    // Check for custom time range
    const timeRange = document.getElementById('timeRangeFilter').value;
    if (timeRange === 'custom') {
        const timeFrom = document.getElementById('timeFrom').value;
        const timeTo = document.getElementById('timeTo').value;
        if (timeFrom) {
            const fromInput = document.createElement('input');
            fromInput.type = 'hidden';
            fromInput.name = 'time_from';
            fromInput.value = timeFrom;
            form.appendChild(fromInput);
        }
        if (timeTo) {
            const toInput = document.createElement('input');
            toInput.type = 'hidden';
            toInput.name = 'time_to';
            toInput.value = timeTo;
            form.appendChild(toInput);
        }
    }

    // Preserve current page if exists
    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = urlParams.get('page');
    if (currentPage && currentPage !== '1') {
        const pageInput = document.createElement('input');
        pageInput.type = 'hidden';
        pageInput.name = 'page';
        pageInput.value = '1'; // Reset to first page when filtering
        form.appendChild(pageInput);
    }

    document.body.appendChild(form);
    form.submit();
}

function resetFilters() {
    // Clear all filter inputs
    const filterInputs = document.querySelectorAll('.filter-input');
    filterInputs.forEach(input => {
        if (input.type === 'select-one') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });
    
    // Redirect to clean URL
    window.location.href = window.location.pathname;
}

function clearAllFilters() {
    if (confirm('Are you sure you want to clear all filters?')) {
        resetFilters();
    }
}

function refreshLogs() {
    window.location.reload();
}

// Global search functionality
document.addEventListener('DOMContentLoaded', function() {
    const globalSearch = document.getElementById('globalSearch');
    if (globalSearch) {
        globalSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim();
                if (searchTerm) {
                    // Add search term to URL and reload
                    const url = new URL(window.location);
                    url.searchParams.set('search', searchTerm);
                    window.location.href = url.toString();
                } else {
                    // Remove search parameter if empty
                    const url = new URL(window.location);
                    url.searchParams.delete('search');
                    window.location.href = url.toString();
                }
            }
        });
        
        // Set current search value if exists
        const urlParams = new URLSearchParams(window.location.search);
        const currentSearch = urlParams.get('search');
        if (currentSearch) {
            globalSearch.value = currentSearch;
        }
    }

    // Initialize filter sidebar based on screen size
    const sidebar = document.getElementById('filterSidebar');
    const mainContent = document.querySelector('.logs-main-content');
    
    console.log('Sidebar element:', sidebar);
    console.log('Main content element:', mainContent);
    console.log('Window width:', window.innerWidth);
    
    // Always show sidebar by default on desktop, only hide on mobile
    if (window.innerWidth < 768) {
        console.log('Hiding sidebar for mobile');
        sidebar.classList.add('hidden');
        mainContent.classList.add('sidebar-hidden');
    } else {
        // Ensure sidebar is visible on desktop
        console.log('Showing sidebar for desktop');
        sidebar.classList.remove('hidden');
        mainContent.classList.remove('sidebar-hidden');
    }

    // Add event listeners for filter inputs (real-time filtering for some fields)
    const filterInputs = document.querySelectorAll('.filter-input');
    filterInputs.forEach(input => {
        if (input.type === 'select-one') {
            input.addEventListener('change', function() {
                // Auto-apply for select fields
                if (this.name === 'time_range') {
                    applyFilters();
                }
            });
        }
    });

    // Time range tabs functionality
    const timeTabs = document.querySelectorAll('.time-tab');
    const timeRangeSelect = document.getElementById('timeRangeFilter');
    const customTimeRange = document.getElementById('customTimeRange');
    
    // Set active tab based on current selection
    const currentTimeRange = timeRangeSelect.value;
    timeTabs.forEach(tab => {
        if (tab.dataset.range === currentTimeRange) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Show custom time range if selected
    if (currentTimeRange === 'custom') {
        customTimeRange.style.display = 'block';
    }
    
    timeTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs
            timeTabs.forEach(t => t.classList.remove('active'));
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Update hidden select value
            const range = this.dataset.range;
            timeRangeSelect.value = range;
            
            // Show/hide custom time range
            if (range === 'custom') {
                customTimeRange.style.display = 'block';
            } else {
                customTimeRange.style.display = 'none';
                // Auto-apply filters for non-custom ranges
                applyFilters();
            }
        });
    });

    // Quick filters functionality
    const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');
    quickFilterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const filterType = this.dataset.filter;
            
            // Clear existing filters
            document.querySelectorAll('.filter-input').forEach(input => {
                if (input.type === 'select-one') {
                    input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
            });
            
            // Apply quick filter presets
            switch(filterType) {
                case 'denied':
                    document.querySelector('select[name="action"]').value = 'deny';
                    break;
                case 'high-traffic':
                    document.querySelector('input[name="min_bytes"]').value = '1000000';
                    break;
                case 'suspicious':
                    document.querySelector('input[name="min_duration"]').value = '10000';
                    document.querySelector('select[name="action"]').value = 'deny';
                    break;
                case 'external':
                    // Filter for external IPs - we'll set a special marker that backend can handle
                    document.querySelector('input[name="srcip"]').value = 'external_only';
                    break;
            }
            
            // Mark button as active
            quickFilterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Apply filters
            applyFilters();
        });
    });

    // IP validation
    const ipInputs = document.querySelectorAll('input[name="srcip"], input[name="dstip"]');
    ipInputs.forEach(input => {
        input.addEventListener('input', function() {
            const value = this.value.trim();
            if (value === '') {
                this.classList.remove('valid', 'invalid');
                return;
            }
            
            // Basic IP validation regex
            const ipRegex = /^(\d{1,3}\.){0,3}\d{0,3}$/;
            const fullIpRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
            
            if (ipRegex.test(value)) {
                if (fullIpRegex.test(value)) {
                    // Validate each octet
                    const octets = value.split('.');
                    const isValid = octets.every(octet => parseInt(octet) <= 255);
                    this.classList.toggle('valid', isValid);
                    this.classList.toggle('invalid', !isValid);
                } else {
                    // Partial IP, remove validation classes
                    this.classList.remove('valid', 'invalid');
                }
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
            }
        });
        
        // Real-time filtering on Enter key
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    });

    // Port validation
    const portInputs = document.querySelectorAll('input[name="srcport"], input[name="dstport"]');
    portInputs.forEach(input => {
        input.addEventListener('input', function() {
            const value = this.value.trim();
            if (value === '') {
                this.classList.remove('valid', 'invalid');
                return;
            }
            
            // Allow single port or range (e.g., 80 or 80-443)
            const portRegex = /^\d{1,5}(-\d{1,5})?$/;
            if (portRegex.test(value)) {
                const ports = value.split('-');
                const isValid = ports.every(port => {
                    const portNum = parseInt(port);
                    return portNum >= 1 && portNum <= 65535;
                });
                this.classList.toggle('valid', isValid);
                this.classList.toggle('invalid', !isValid);
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
            }
        });
    });

    // Show active filter count
    function updateFilterCount() {
        let count = 0;
        document.querySelectorAll('.filter-input:not(.hidden)').forEach(input => {
            if (input.value.trim() && input.value !== '') {
                if (input.type === 'select-one' && input.selectedIndex !== 0) {
                    count++;
                } else if (input.type !== 'select-one') {
                    count++;
                }
            }
        });
        
        // Update filter button with count
        const filterBtn = document.querySelector('button[onclick="toggleFilters()"]');
        if (filterBtn) {
            const existingBadge = filterBtn.querySelector('.filter-count-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            if (count > 0) {
                const badge = document.createElement('span');
                badge.className = 'filter-count-badge';
                badge.textContent = count;
                filterBtn.appendChild(badge);
            }
        }
    }
    
    // Update filter count on page load
    updateFilterCount();
    
    // Update filter count when filters change
    document.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('change', updateFilterCount);
        input.addEventListener('input', updateFilterCount);
    });
});

// Responsive filter sidebar handling
window.addEventListener('resize', function() {
    const sidebar = document.getElementById('filterSidebar');
    const mainContent = document.querySelector('.logs-main-content');
    
    if (window.innerWidth >= 768) {
        sidebar.classList.remove('hidden');
        mainContent.classList.remove('sidebar-hidden');
    } else {
        sidebar.classList.add('hidden');
        mainContent.classList.add('sidebar-hidden');
    }
});

document.addEventListener('DOMContentLoaded', function () {
    const headers = document.querySelectorAll('.sidebar-header.collapsible-header'); // More specific selector
    console.log('Found collapsible headers:', headers.length); 

    headers.forEach(header => {
        header.addEventListener('click', function () {
            const targetId = this.dataset.target;
            console.log('Header clicked. Target ID: ' + targetId);
            console.log('Clicked element outerHTML: ' + (this.outerHTML || 'N/A')); 

            if (!targetId) {
                console.error('No data-target found for this header. Element:');
                console.error('The problematic header element outerHTML: ' + (this.outerHTML || 'N/A')); 
                return;
            }

            const content = document.getElementById(targetId);
            const icon = this.querySelector('i.fas');

            if (content) {
                console.log('Target content element outerHTML: ' + (content.outerHTML || 'N/A'));
                console.log('Current display: ' + content.style.display); 
                
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    console.log('Set content to display: block'); 
                    if (icon) {
                        icon.classList.remove('fa-plus');
                        icon.classList.add('fa-minus');
                    }
                } else {
                    content.style.display = 'none';
                    console.log('Set content to display: none'); 
                    if (icon) {
                        icon.classList.remove('fa-minus');
                        icon.classList.add('fa-plus');
                    }
                }
            } else {
                console.error('Target content not found for ID:', targetId); 
            }
        });
    });
});
</script>
    <div id="wafRulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>WAF Rules</h3>
                <button class="close-modal-button" data-target="wafRulesModal">×</button>
            </div>
            <div class="modal-body">
                <p>This is a placeholder for WAF Rules content.</p>
            </div>
        </div>
    </div>

    <script>
        // Pass the logs data from Django to JavaScript
        const logData = {{ logs_json_for_expansion|safe|default:"[]" }};
        
        document.addEventListener('DOMContentLoaded', function () {
            // Sidebar Accordion
            const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
            collapsibleHeaders.forEach(header => {
                header.addEventListener('click', function () {
                    const contentId = this.dataset.target;
                    const content = document.getElementById(contentId);
                    const icon = this.querySelector('i');
                    content.classList.toggle('open');
                    if (content.classList.contains('open')) {
                        icon.classList.remove('fa-plus');
                        icon.classList.add('fa-minus');
                    } else {
                        icon.classList.remove('fa-minus');
                        icon.classList.add('fa-plus');
                    }
                });
            });
            document.querySelectorAll('.collapsible-content.open').forEach(openContent => {
                const header = document.querySelector(`.collapsible-header[data-target="${openContent.id}"]`);
                if (header) {
                    const icon = header.querySelector('i');
                    icon.classList.remove('fa-plus');
                    icon.classList.add('fa-minus');
                }
            });

            // Initialize logData from Django context
            const logData = JSON.parse('{{ logs_json_for_expansion|escapejs|default:"[]" }}');
            
            const logsTableBody = document.getElementById('logsTableBody');
            
            // Optional: Calculate maxDuration if you want to use it for something dynamically in JS
            // const maxDuration = logData.length > 0 ? Math.max(...logData.map(log => log.duration_ms || 0), 100) : 100;

            // Log Row Expansion
            logsTableBody.addEventListener('click', function(event) {
                console.log('Expand button click handler initiated.');
                const button = event.target.closest('.expand-log-button');
                if (!button) return;

                event.preventDefault(); // Prevent default <a> tag behavior (page jump/reload)
                console.log('Default event action prevented.');
                event.stopPropagation(); // Stop event from bubbling up
                console.log('Event propagation stopped.');

                if (button.dataset.handlingClick === 'true') {
                    console.log('Click handling already in progress for this button. Exiting.');
                    return;
                }
                console.log('Setting handlingClick = true');
                button.dataset.handlingClick = 'true';

                try {
                    const icon = button.querySelector('i');
                    const currentRow = button.closest('tr');
                    const logIndex = parseInt(button.dataset.logIndex);
                    console.log('Button clicked for log index:', logIndex, 'Current icon class:', icon.className);

                    if (!(logIndex >= 0 && logIndex < logData.length)) {
                        console.error("Log data not found for index:", logIndex, "Max index:", logData.length - 1);
                        return; // Flag will be cleared in finally
                    }
                    const log = logData[logIndex];

                    if (icon.classList.contains('fa-plus')) { // EXPAND action
                        console.log('Attempting to EXPAND row for log index:', logIndex);
                        // First, close any other open detail rows
                        const allOpenDetailRows = logsTableBody.querySelectorAll('tr.expanded-log-details');
                        allOpenDetailRows.forEach(openDetailRow => {
                            console.log('Closing an already open detail row.');
                            const associatedButtonIcon = openDetailRow.previousElementSibling.querySelector('.expand-log-button i');
                            openDetailRow.remove();
                            if (associatedButtonIcon) {
                                associatedButtonIcon.classList.remove('fa-minus');
                                associatedButtonIcon.classList.add('fa-plus');
                            }
                        });

                        // Create and insert the new detail row
                        const detailRow = document.createElement('tr');
                        detailRow.classList.add('expanded-log-details');
                        const cell = document.createElement('td');
                        cell.colSpan = currentRow.cells.length;
                        
                        cell.innerHTML = `
                            <div class="expanded-log-content">
                                <div class="metrics-summary-bar">
                                    <div class="metric-item">
                                        <i class="fas fa-user-circle metric-icon icon-client"></i>
                                        <span class="metric-label">Client RTT</span>
                                        <span class="metric-value">${log.client_rtt || 'N/A'} ms</span>
                                    </div>
                                    <div class="metric-item">
                                        <i class="fas fa-server metric-icon icon-server"></i>
                                        <span class="metric-label">Server RTT</span>
                                        <span class="metric-value">${log.target_rtt || 'N/A'} ms</span>
                                    </div>
                                    <div class="metric-item">
                                        <i class="fas fa-sync-alt metric-icon icon-app"></i>
                                        <span class="metric-label">App Latency</span>
                                        <span class="metric-value">${log.app_latency || 'N/A'} ms</span>
                                    </div>
                                </div>
                                <div class="detailed-info-grid">
                                    <div class="info-column">
                                        <p><strong>Source IP:</strong> ${log.srcip || 'N/A'}</p>
                                        <p><strong>Username:</strong> ${log.username || 'N/A'}</p>
                                        <p><strong>Source Port:</strong> ${log.srcport || 'N/A'}</p> 
                                        <p><strong>Source Interface:</strong> ${log.srcintf || 'N/A'}</p>
                                        <p><strong>Device:</strong> ${log.device_name || 'N/A'}</p>
                                        <p><strong>Start time:</strong> ${log.ts_display || 'N/A'}</p>
                                        <p><strong>Source Country:</strong> ${log.srccountry || 'N/A'}</p>
                                        <p><strong>Log Source:</strong> 
                                            <span class="source-badge source-${log.log_source || 'unknown'}">
                                                ${log.log_source === 'fortigate_traffic' ? 'FortiGate' : 
                                                  log.log_source === 'pa_traffic' ? 'PaloAlto' : 
                                                  log.log_source === 'threat_logs' ? 'Threat' : 
                                                  (log.log_source || 'Unknown')}
                                            </span>
                                        </p>
                                    </div>
                                    <div class="info-column">
                                        <p><strong>Destination IP:</strong> ${log.dstip || 'N/A'}</p>
                                        <p><strong>Destination Port:</strong> ${log.dstport_val || 'N/A'}</p>
                                        <p><strong>Destination Interface:</strong> ${log.dstintf || 'N/A'}</p>
                                        <p><strong>Response Length:</strong> ${log.rcvdbyte_display || 'N/A'}</p>
                                        <p><strong>Persistence Session ID:</strong> ${log.sessionid || 'N/A'}</p>
                                        <p><strong>Destination Country:</strong> ${log.dstcountry || 'N/A'}</p>
                                        ${log.application && log.application !== 'N/A' ? `<p><strong>Application:</strong> ${log.application}</p>` : ''}
                                        ${log.threat_id && log.threat_id !== '' ? `<p><strong>Threat ID:</strong> ${log.threat_id}</p>` : ''}
                                        ${log.severity && log.severity !== '' ? `<p><strong>Severity:</strong> ${log.severity}</p>` : ''}
                                    </div>
                                    <div class="info-column server-ip-column">
                                        <p><strong>Policy Name:</strong> ${log.policyname || 'N/A'}</p> 
                                        <p><strong>Duration:</strong> ${log.duration_display || 'N/A'}</p>
                                        <p><strong>Sent Byte:</strong> ${log.sentbyte_display || 'N/A'}</p>
                                        <p><strong>Received Byte:</strong> ${log.rcvdbyte_display || 'N/A'}</p>
                                        <p><strong>Sent Packet:</strong> ${log.sentpkt || 'N/A'}</p>
                                        <p><strong>Received Packet:</strong> ${log.rcvdpkt || 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="view-headers-container">
                                    <a href="#" class="view-all-headers-link">View All Headers (Placeholder)</a>
                                </div>
                                <div class="log-details-tabs-container">
                                    <div class="log-details-tabs" data-log-index="${logIndex}">
                                        <button class="tab-button active" data-tab="response-info-tab-${logIndex}">Response Information</button>
                                    </div>
                                    <div id="response-info-tab-${logIndex}" class="tab-content active">
                                        <div class="raw-message-section">
                                            <h4>Raw Message</h4>
                                            <pre class="raw-message">${log.raw_message || 'No raw message available'}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        detailRow.appendChild(cell);
                        logsTableBody.insertBefore(detailRow, currentRow.nextSibling);
                        console.log('Detail row added for log index:', logIndex);

                        // Tab handling for the newly created detail row
                        const tabContainer = cell.querySelector(`.log-details-tabs[data-log-index="${logIndex}"]`);
                        if (tabContainer) {
                            tabContainer.addEventListener('click', function(e) {
                                if (e.target.classList.contains('tab-button')) {
                                    const targetTabId = e.target.dataset.tab;
                                    tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                                    const parentContent = tabContainer.closest('.expanded-log-content');
                                    parentContent.querySelectorAll('.log-details-tabs-container .tab-content').forEach(content => content.classList.remove('active'));
                                    e.target.classList.add('active');
                                    const targetContentElement = parentContent.querySelector(`#${targetTabId}`);
                                    if (targetContentElement) {
                                        targetContentElement.classList.add('active');
                                    }
                                }
                            });
                        }

                        icon.classList.remove('fa-plus');
                        icon.classList.add('fa-minus');
                        console.log('Icon changed to fa-minus for log index:', logIndex);

                    } else if (icon.classList.contains('fa-minus')) { // COLLAPSE action
                        console.log('Attempting to COLLAPSE row for log index:', logIndex);
                        const detailRowToRemove = currentRow.nextElementSibling;
                        if (detailRowToRemove && detailRowToRemove.classList.contains('expanded-log-details')) {
                            detailRowToRemove.remove();
                            console.log('Detail row removed for log index:', logIndex);
                        }
                        icon.classList.remove('fa-minus');
                        icon.classList.add('fa-plus');
                        console.log('Icon changed to fa-plus for log index:', logIndex);
                    }
                } finally {
                    setTimeout(() => {
                        console.log('Clearing handlingClick flag for log index:', button.dataset.logIndex);
                        delete button.dataset.handlingClick;
                    }, 50); // Increased timeout slightly to ensure DOM updates are processed
                }
            });

            // Chart.js Configuration (Only if canvas element exists)
            const canvasCtx = document.getElementById('logsChart');
            if (canvasCtx) {
                const ctx = canvasCtx.getContext('2d');
                new Chart(ctx, { 
                    type: 'bar',
                    data: {
                        labels: ['Wed 14', '', 'Thu 15', '', 'Fri 16', '', 'Sat 17', '', 'Aug 18', '', 'Mon 19', '', 'Tue 20'], // TODO: Dynamic labels
                        datasets: [{
                            label: 'Non-Significant Logs', // TODO: Dynamic data
                            data: [100, 150, 120, 180, 200, 220, 300, 250, 4000, 4200, 1000, 800, 2000],
                            backgroundColor: '#4CAF50',
                            barPercentage: 0.7,
                            categoryPercentage: 0.7
                        }, {
                            label: 'Significant Logs', // TODO: Dynamic data
                            data: [20, 30, 25, 35, 40, 45, 600, 50, 2000, 2100, 500, 400, 1000],
                            backgroundColor: '#FF9800',
                            barPercentage: 0.7,
                            categoryPercentage: 0.7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Allow chart to shrink
                        scales: { x: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } }, y: { stacked: true, beginAtZero: true, grid: { color: '#e9ecef' }, ticks: { font: { size: 10 }, callback: function(value) { if (value >= 1000) return (value/1000) + 'k'; return value; } } } },
                        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
                    }
                });
            }


            // Modal Handling
            const wafRulesLink = document.getElementById('wafRulesLink');
            const modal = document.getElementById('wafRulesModal');
            const closeModalButtons = document.querySelectorAll('.close-modal-button');

            if (wafRulesLink && modal) {
                wafRulesLink.addEventListener('click', function(e) { e.preventDefault(); modal.style.display = "block"; });
                closeModalButtons.forEach(button => { button.addEventListener('click', function() { document.getElementById(this.dataset.target).style.display = "none"; }); });
                window.addEventListener('click', function(event) { if (event.target == modal) { modal.style.display = "none"; } });
            }
        });
    </script>
{% endblock %}